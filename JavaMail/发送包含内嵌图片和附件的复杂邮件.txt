package attach;

import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;
import javax.activation.DataHandler;
import javax.activation.FileDataSource;
import javax.mail.BodyPart;
import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Multipart;
import javax.mail.Session;
import javax.mail.Transport;
import javax.mail.internet.AddressException;
import javax.mail.internet.InternetAddress;
import javax.mail.internet.MimeBodyPart;
import javax.mail.internet.MimeMessage;
import javax.mail.internet.MimeMultipart;

import com.sun.xml.internal.ws.client.sei.ResponseBuilder.Body;
/**发送包含内嵌图片和附件的复杂邮件
 * @author 老腰
 */
public class SendAlternative {
	public static void main(String[] args) throws AddressException, IOException, MessagingException {
		sendAlternate();
	}
	
	public static void sendAlternate() throws IOException, AddressException, MessagingException {
		//1、创建配置对象
		Properties prop = new Properties();
		InputStream in = SendAlternative.class.getClassLoader().getResourceAsStream("db.properties");
		prop.load(in);
		
		//2、创建session对象
		Session session = Session.getDefaultInstance(prop);
		//开启session的Debug模式
		session.setDebug(true);
		
		//3、创建邮件对象
		Message message = createMessage(session, "tan_qi@sohu.com");
		
		//4、创建邮件发送对象
		Transport transport = session.getTransport();
		//打开服务器连接
		transport.connect("smtp.sohu.com", "tan_qi@sohu.com", "tq6020162483");
		//发送邮件
		transport.sendMessage(message, message.getAllRecipients());
	
		//关闭连接
		transport.close();
		
	}
	
	/**
	 * 创建邮件并且编写邮件内容
	 * @param session  与服务器相连接的对象
	 * @param address  收件人地址
	 * @throws MessagingException 
	 * @throws AddressException 
	 * @throws IOException 
	 * @throws FileNotFoundException 
	 */
	public static Message createMessage(Session session,String recipitAddress) throws AddressException, MessagingException, FileNotFoundException, IOException {
		Message message = new MimeMessage(session);
		//设置邮件发件人
		message.setFrom(new InternetAddress("tan_qi@sohu.com"));
		//设置邮件接收人
		message.setRecipient(Message.RecipientType.TO, new InternetAddress(recipitAddress));
		//设置邮件标题
		message.setSubject("带有内嵌图片以及复杂附件的邮件");
		
		//正文HTML部分
		BodyPart text = new MimeBodyPart();
		text.setContent("内嵌图片<img src='cid:winter.jpg'>","text/html;charset=utf-8");
		
		//内嵌附件img部分
		BodyPart image = new MimeBodyPart();
		DataHandler dataHandler = new DataHandler(new FileDataSource("WebContent/images/winter.jpg"));
		image.setDataHandler(dataHandler);
		((MimeBodyPart)image).setContentID("winter.jpg");
		
		//描述关系：正文和图片
		Multipart multipart = new MimeMultipart();
	    multipart.addBodyPart(text);
	    multipart.addBodyPart(image);
	    //设置multipart的类型
	    ((MimeMultipart)multipart).setSubType("related");
	    
	    //附件1
	    BodyPart attach1 = new MimeBodyPart();
	    DataHandler dataHandler2 = new DataHandler(new FileDataSource("WebContent/source/a.zip"));
	    attach1.setDataHandler(dataHandler2);
	    attach1.setFileName(dataHandler2.getName());
	    
	    //附件2
	    BodyPart attach2 = new MimeBodyPart();
	    DataHandler dataHandler3 = new DataHandler(new FileDataSource("WebContent/source/b.zip"));
	    attach2.setDataHandler(dataHandler3);
	    attach2.setFileName(dataHandler3.getName());
	    
	    //描述关系：附件和附件
	    Multipart multipart2 = new MimeMultipart();
	    multipart2.addBodyPart(attach1);
	    multipart2.addBodyPart(attach2);
	    
	    //代表正文的bodyPart
	    BodyPart content = new MimeBodyPart();
	    content.setContent(multipart);
	    multipart2.addBodyPart(content);
	    ((MimeMultipart)multipart2).setSubType("mixed");
	    
	    //设置邮件的内容
	    message.setContent(multipart2);
	    message.saveChanges();
	    
	    //将邮件写入指定的路径
	    message.writeTo(new FileOutputStream("D:\\JAVA基础学习\\JavaMail\\MixedEmail.eml"));
		
		return message;
	}
	
}
